/*!
 * @cloudbase/weda-cloud-sdk_open-api
 * CopyrightÂ© 2024 Tencent
 */
!function(e,o){"object"==typeof exports&&"undefined"!=typeof module?o(exports):"function"==typeof define&&define.amd?define(["exports"],o):o((e="undefined"!=typeof globalThis?globalThis:e||self).CloudOpenApi={})}(this,(function(e){"use strict";function o(e,o,t,r){return new(t||(t=Promise))((function(n,i){function d(e){try{a(r.next(e))}catch(e){i(e)}}function s(e){try{a(r.throw(e))}catch(e){i(e)}}function a(e){var o;e.done?n(e.value):(o=e.value,o instanceof t?o:new t((function(e){e(o)}))).then(d,s)}a((r=r.apply(e,o||[])).next())}))}let t,r,n=0,i=0;const d=[];for(let e=0;e<256;++e)d[e]=(e+256).toString(16).substr(1);const s={bytesToUuid:(e,o)=>{let t="";for(let r=0;r<16;r++)t+=d[e[r]],o||-1===[3,5,7,9].indexOf(r)||(t+="-");return t},uuid:(e=!1)=>{let o=0;const d=[];let a=t,c=r;if(!a||!c){const e=`${Math.random()}`.substr(3,19);a||(t=[1|e[0],e[1],e[2],e[3],e[4],e[5]],a=t),c||(r=16383&(e[6]<<8|e[7]),c=r)}let l=(new Date).getTime(),u=i+1;const p=l-n+(u-i)/1e4;if(p<0&&(c=c+1&16383),(p<0||l>n)&&(u=0),u>=1e4)throw new Error("uuid: Can't create more than 10M uuids/sec");n=l,i=u,r=c,l+=122192928e5;const h=(1e4*(268435455&l)+u)%4294967296;d[o++]=h>>>24&255,d[o++]=h>>>16&255,d[o++]=h>>>8&255,d[o++]=255&h;const v=l/4294967296*1e4&268435455;d[o++]=v>>>8&255,d[o++]=255&v,d[o++]=v>>>24&15|16,d[o++]=v>>>16&255,d[o++]=c>>>8|128,d[o++]=255&c;for(let e=0;e<6;++e)d[10+e]=a[e];return s.bytesToUuid(d,e)},uuidWithoutLine:()=>s.uuid(!0)};function a(e){const{path:o,envId:t}=e,r=function(e,o){var t={};for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&o.indexOf(r)<0&&(t[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var n=0;for(r=Object.getOwnPropertySymbols(e);n<r.length;n++)o.indexOf(r[n])<0&&Object.prototype.propertyIsEnumerable.call(e,r[n])&&(t[r[n]]=e[r[n]])}return t}(e,["path","envId"]);r.headers||(r.headers={}),"PATCH"===r.method&&(r.headers["X-HTTP-Method-Override"]="PATCH",r.method="POST"),r.body&&"string"!=typeof r.body&&(r.body=JSON.stringify(r.body,((e,o)=>{if(o&&""!==o)return o})));const n=`${t}.ap-shanghai.tcb-api.tencentcloudapi.com`;r.headers["x-host"]=n;return{url:`https://${n}${o}${-1!=o.indexOf("?")?`&env=${t}`:`?env=${t}`}`,body:r.body,method:r.method,headers:r.headers}}function c(e,t){var r,n,i,d,s,c;return o(this,void 0,void 0,(function*(){const o=wx.cloud;o.init({env:t});let l="";try{const e=yield o.callFunction({name:"lowcode-datasource",data:{mode:"c",methodName:"callWedaApi",params:{action:"GetMiniProgramUserTicket",data:{Type:"externalUser",OnlyOpenId:!0}}}});if(l=(null===(n=null===(r=null==e?void 0:e.result)||void 0===r?void 0:r.data)||void 0===n?void 0:n.Data)||"",!l)return""}catch(e){return console.log("=======> [getUrlWithOpenidTokenWxCloud]: GetMiniProgramUserTicket error ",e),""}try{const{miniProgram:r}=wx.getAccountInfoSync(),{url:n,method:u,headers:p,body:h}=a({path:"/auth/v1/provider/token",method:"POST",body:{provider_access_token:`${t} ${l}`,provider_id:null==r?void 0:r.appId,provider_params:{provider_code_type:"open_id"}},envId:t}),v=yield o.callFunction({name:"httpOverCallFunction",data:{url:n,method:u,headers:Object.assign({origin:"https://servicewechat.com"},p),body:h}});if(null===(d=null===(i=null==v?void 0:v.result)||void 0===i?void 0:i.body)||void 0===d?void 0:d.error_code)return console.log("=======> [getUrlWithOpenidTokenWxCloud]: grantProviderToken error ",null===(s=null==v?void 0:v.result)||void 0===s?void 0:s.body),"";const{provider_token:f}=(null===(c=null==v?void 0:v.result)||void 0===c?void 0:c.body)||{};let[y="",g="",b=""]=e.split(/(?:\?|#)+/);return g.startsWith("/")&&(b=g,g=""),`${y}?${g}${g?"&":""}wx_access_token=${f}${b?"#":""}${b}`}catch(e){console.log("=======> [getUrlWithOpenidTokenWxCloud]: grantProviderToken error ",e)}return""}))}e.getUrlWithOpenidToken=function(e,t,r){return o(this,void 0,void 0,(function*(){return"function"==typeof wx.login&&e&&t?r?yield c(e,t):new Promise((r=>{wx.login({success:n=>o(this,void 0,void 0,(function*(){const{miniProgram:i}=wx.getAccountInfoSync();try{const{provider_token:c}=yield(d="/auth/v1/provider/token",a={body:{provider_code:n.code,provider_id:null==i?void 0:i.appId,provider_params:{provider_code_type:"open_id"}},envId:t},o(void 0,void 0,void 0,(function*(){var e;const o=Object.assign(Object.assign({},a),{method:a.method||"POST",body:"string"==typeof a.body?a.body:JSON.stringify(a.body,((e,o)=>{if(o&&""!==o)return o})),headers:Object.assign(Object.assign({},a.headers),{"x-request-id":(null===(e=a.headers)||void 0===e?void 0:e["x-request-id"])||s.uuid(),host:`${a.envId}.ap-shanghai.tcb-api.tencentcloudapi.com`})}),{"x-request-id":t,host:r}=o.headers,n=`https://${r}${d}`;return new Promise(((e,r)=>{wx.request({url:n,data:o.body,method:o.method,header:o.headers,success(o){let n;"object"==typeof o.data?(n=o.data,n.code&&(n={error:n.code,error_description:n.message||n.code,request_id:n.requestId||t,error_path:d})):n={error:"unreachable",error_description:`resp data error for - ${o.data}`,request_id:t,error_path:d},n.error?(n.error_path=d,r(n)):e(n)},fail(e){const o={error:"unreachable",error_description:e.errMsg,error_path:d,request_id:t};r(o)}})}))})));let[l="",u="",p=""]=e.split(/(?:\?|#)+/);u.startsWith("/")&&(p=u,u="");r(`${l}?${u}${u?"&":""}wx_access_token=${c}${p?"#":""}${p}`)}catch(e){console.log("=======> [getUrlWithOpenidToken]: grantProviderToken error ",e),r("")}var d,a})),fail:e=>{console.log("=======> [getUrlWithOpenidToken]: wx.login fail ",e),r("")}})})):""}))},e.getUrlWithOpenidTokenWxCloud=c,Object.defineProperty(e,"__esModule",{value:!0})}));
